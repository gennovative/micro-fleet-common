{"version":3,"sources":["app/validators/JoiModelValidator.ts"],"names":[],"mappings":"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","file":"JoiModelValidator.js","sourcesContent":["import * as joi from 'joi';\r\nimport { Guard } from 'back-lib-common-util';\r\n\r\nimport { ValidationError } from './ValidationError';\r\n\r\n\r\nexport interface ValidationOptions extends joi.ValidationOptions {\r\n}\r\n\r\nexport class JoiModelValidator<T> {\r\n\r\n\t/**\r\n\t * Builds a new instance of ModelValidatorBase.\r\n\t * @param {joi.SchemaMap} schemaMapModel Rules to validate model properties.\r\n\t * @param {boolean} isCompoundPk Whether the primary key is compound. Default to `false`.\r\n\t * \tThis param is IGNORED if param `schemaMapPk` has value.\r\n\t * @param {boolean} requirePk Whether to validate PK.\r\n\t * \tThis param is IGNORED if param `schemaMapPk` has value.\r\n\t * @param {joi.SchemaMap} schemaMapPk Rule to validate model PK.\r\n\t */\r\n\tpublic static create<T>(schemaMapModel: joi.SchemaMap, isCompoundPk: boolean = false, requirePk: boolean = true, schemaMapPk?: joi.SchemaMap): JoiModelValidator<T> {\r\n\t\tlet validator = new JoiModelValidator<T>(schemaMapModel, isCompoundPk, requirePk, schemaMapPk);\r\n\t\tvalidator.compile();\r\n\t\treturn validator;\r\n\t}\r\n\r\n\r\n\t/**\r\n\t * Compiled rules for compound model primary key.\r\n\t */\r\n\tprotected _compiledPk: joi.ObjectSchema;\r\n\r\n\t/**\r\n\t * Compiled rules for model properties.\r\n\t */\r\n\tprotected _compiledWhole: joi.ObjectSchema;\r\n\r\n\t/**\r\n\t * Compiled rules for model properties, but all of them are OPTIONAL.\r\n\t * Used for patch operation.\r\n\t */\r\n\tprotected _compiledPartial: joi.ObjectSchema;\r\n\r\n\r\n\t/**\r\n\t * @param {joi.SchemaMap} _schemaMap Rules to validate model properties.\r\n\t * @param {boolean} _isCompositePk Whether the primary key is compound. Default to `false`\r\n\t * \tThis param is IGNORED if param `schemaMapPk` has value.\r\n\t * @param {boolean} requirePk Whether to validate ID.\r\n\t * \tThis param is IGNORED if param `schemaMapPk` has value.\r\n\t * @param {joi.SchemaMap} _schemaMapId Rule to validate model PK.\r\n\t */\r\n\tprotected constructor(\r\n\t\tprotected _schemaMap: joi.SchemaMap,\r\n\t\tprotected _isCompositePk: boolean = false,\r\n\t\trequirePk: boolean,\r\n\t\tprotected _schemaMapPk?: joi.SchemaMap,\r\n\t) {\r\n\t\t// As default, model ID is a string of 64-bit integer.\r\n\t\t// JS cannot handle 64-bit integer, that's why we must use string.\r\n\t\t// The database will convert to BigInt type when inserting.\r\n\t\tlet idSchema = joi.string().regex(/^\\d+$/);\r\n\t\tif (requirePk) {\r\n\t\t\tidSchema = idSchema.required();\r\n\t\t}\r\n\r\n\t\tif (_schemaMapPk) {\r\n\t\t\tthis._schemaMapPk = _schemaMapPk;\r\n\t\t} else if (_isCompositePk) {\r\n\t\t\t// this._compiledPk = joi.object({\r\n\t\t\t// \t\tid: idSchema,\r\n\t\t\t// \t\ttenantId: idSchema\r\n\t\t\t// \t})\r\n\t\t\t// \t.required();\r\n\t\t\tthis._schemaMapPk = {\r\n\t\t\t\t\tid: idSchema,\r\n\t\t\t\t\ttenantId: idSchema\r\n\t\t\t\t};\r\n\t\t} else {\r\n\t\t\tthis._schemaMapPk = { id: idSchema };\r\n\t\t\tthis._compiledPk = <any>idSchema;\r\n\t\t}\r\n\t}\r\n\r\n\r\n\tpublic get schemaMap(): joi.SchemaMap {\r\n\t\treturn this._schemaMap;\r\n\t}\r\n\r\n\tpublic get schemaMapPk(): joi.SchemaMap {\r\n\t\treturn this._schemaMapPk;\r\n\t}\r\n\r\n\tpublic get isCompoundPk(): boolean {\r\n\t\treturn this._isCompositePk;\r\n\t}\r\n\r\n\r\n\t/**\r\n\t * Validates model PK.\r\n\t */\r\n\tpublic pk(pk: any): [ValidationError, any] {\r\n\t\tGuard.assertIsDefined(this._compiledPk, 'Must call `compile` before using this function!');\r\n\t\tlet { error, value } = this._compiledPk.validate<any>(pk);\r\n\t\treturn (error) ? [new ValidationError(error.details), null] : [null, value];\r\n\t}\r\n\r\n\t/**\r\n\t * Validates model for creation operation, which doesn't need `pk` property.\r\n\t */\r\n\tpublic whole(target: any, options: ValidationOptions = {}): [ValidationError, T] {\r\n\t\treturn this.validate(this._compiledWhole, target, options);\r\n\t}\r\n\r\n\t/**\r\n\t * Validates model for modification operation, which requires `pk` property.\r\n\t */\r\n\tpublic partial(target: any, options: ValidationOptions = {}): [ValidationError, Partial<T>] {\r\n\t\treturn this.validate(this._compiledPartial, target, options);\r\n\t}\r\n\r\n\t/**\r\n\t * Must call this method before using `whole` or `partial`,\r\n\t * or after `schemaMap` or `schemaMapId` is changed.\r\n\t */\r\n\tpublic compile(): void {\r\n\r\n\t\tif (!this._compiledPk) {\r\n\t\t\tif (this._isCompositePk) {\r\n\t\t\t\tthis._compiledPk = joi.object(this._schemaMapPk);\r\n\t\t\t} else {\r\n\t\t\t\t// Compile rule for simple PK with only one property\r\n\t\t\t\tlet idMap = this.schemaMapPk;\r\n\t\t\t\tfor (let key in idMap) {\r\n\t\t\t\t\t/* istanbul ignore else */\r\n\t\t\t\t\tif (idMap.hasOwnProperty(key)) {\r\n\t\t\t\t\t\tthis._compiledPk = idMap[key] as joi.ObjectSchema;\r\n\t\t\t\t\t\tbreak; // Only get the first rule\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet wholeSchema = this._schemaMap;\r\n\t\tthis._compiledWhole = joi.object(wholeSchema);\r\n\r\n\t\t// Make all rules optional for partial schema.\r\n\t\tlet partialSchema: joi.SchemaMap = {};\r\n\t\tfor (let key in wholeSchema) {\r\n\t\t\t/* istanbul ignore else */\r\n\t\t\tif (wholeSchema.hasOwnProperty(key)) {\r\n\t\t\t\tlet rule = wholeSchema[key] as joi.Schema;\r\n\t\t\t\t/* istanbul ignore else */\r\n\t\t\t\tif (typeof rule.optional === 'function') {\r\n\t\t\t\t\tpartialSchema[key] = rule.optional();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._compiledPartial = joi.object(partialSchema);\r\n\r\n\t\tthis._compiledWhole = this._compiledWhole.keys(this._schemaMapPk);\r\n\t\tthis._compiledPartial = this._compiledPartial.keys(this._schemaMapPk);\r\n\t}\r\n\r\n\tprotected validate(schema: joi.ObjectSchema, target: any, options: ValidationOptions = {}): [ValidationError, T] {\r\n\t\tGuard.assertIsDefined(schema, 'Must call `compile` before using this function!');\r\n\r\n\t\tlet opts = Object.assign({\r\n\t\t\t\tabortEarly: false,\r\n\t\t\t\tallowUnknown: true,\r\n\t\t\t\tstripUnknown: true\r\n\t\t\t}, options);\r\n\r\n\t\tlet { error, value } = schema.validate<T>(target, opts);\r\n\r\n\t\treturn (error) ? [new ValidationError(error.details), null] : [null, value];\r\n\t}\r\n}"]}