{"version":3,"sources":["app/validators/JoiModelValidator.ts"],"names":[],"mappings":"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","file":"JoiModelValidator.js","sourcesContent":["import * as joi from 'joi';\r\nimport { Guard } from 'back-lib-common-util';\r\n\r\nimport { ValidationError } from './ValidationError';\r\n\r\n\r\nexport interface ValidationOptions extends joi.ValidationOptions {\r\n\t/**\r\n\t * If `true`, this validation is for edit model. Otherwise, for new model.\r\n\t * Default to `false`.\r\n\t */\r\n\tisEdit?: boolean;\r\n}\r\n\r\nexport class JoiModelValidator<T> {\r\n\r\n\t/**\r\n\t * Builds a new instance of ModelValidatorBase.\r\n\t * @param {joi.SchemaMap} schemaMapModel Rules to validate model properties.\r\n\t * @param {joi.SchemaMap} schemaMapId Rule to validate model ID. Only the first property rule is used.\r\n\t */\r\n\tpublic static create<T>(schemaMapModel: joi.SchemaMap, schemaMapId?: joi.SchemaMap): JoiModelValidator<T> {\r\n\t\tlet validator = new JoiModelValidator<T>(schemaMapModel, schemaMapId);\r\n\t\tvalidator.compile();\r\n\t\treturn validator;\r\n\t}\r\n\r\n\r\n\t/**\r\n\t * Compiled rules for model ID.\r\n\t */\r\n\tprotected _compiledId: joi.ObjectSchema;\r\n\r\n\t/**\r\n\t * Compiled rules for model properties.\r\n\t */\r\n\tprotected _compiledWhole: joi.ObjectSchema;\r\n\r\n\t/**\r\n\t * Compiled rules for model properties, but all of them are OPTIONAL.\r\n\t * Used for patch operation.\r\n\t */\r\n\tprotected _compiledPartial: joi.ObjectSchema;\r\n\r\n\r\n\t/**\r\n\t * \r\n\t * @param {joi.SchemaMap} _schemaMap Rules to validate model properties.\r\n\t * @param {joi.SchemaMap} _schemaMapId Rule to validate model ID. Only the first property rule is used.\r\n\t */\r\n\tprotected constructor(\r\n\t\tprotected _schemaMap: joi.SchemaMap,\r\n\t\tprotected _schemaMapId?: joi.SchemaMap\r\n\t) {\r\n\t\t// As default, model ID is a string of 64-bit integer.\r\n\t\t// JS cannot handle 64-bit integer, that's why we must use string.\r\n\t\t// The database will convert to BigInt type when inserting.\r\n\t\tthis._schemaMapId = _schemaMapId || { id: joi.string().regex(/^\\d+$/).required() };\r\n\t}\r\n\r\n\r\n\t/**\r\n\t * Validates model ID.\r\n\t */\r\n\tpublic id(id: any): [ValidationError, any] {\r\n\t\tGuard.assertIsDefined(this._compiledId, 'Must call `compile` before using this function!');\r\n\t\tlet{ error, value } = this._compiledId.validate<any>(id);\r\n\t\treturn (error) ? [new ValidationError(error.details), null] : [null, value];\r\n\t}\r\n\r\n\t/**\r\n\t * Validates model for creation operation, which doesn't need `id` property.\r\n\t */\r\n\tpublic whole(target: any, options: ValidationOptions = {}): [ValidationError, T] {\r\n\t\treturn this.validate(this._compiledWhole, target, options);\r\n\t}\r\n\r\n\t/**\r\n\t * Validates model for modification operation, which requires `id` property.\r\n\t */\r\n\tpublic partial(target: any, options: ValidationOptions = {}): [ValidationError, Partial<T>] {\r\n\t\treturn this.validate(this._compiledPartial, target, options);\r\n\t}\r\n\r\n\r\n\tprotected compile(): void {\r\n\t\tlet wholeSchema = this._schemaMap;\r\n\t\tthis._compiledWhole = joi.object(wholeSchema);\r\n\r\n\t\t// Make all rules optional for partial schema.\r\n\t\tlet partialSchema: joi.SchemaMap = {};\r\n\t\tfor (let key in wholeSchema) {\r\n\t\t\t/* istanbul ignore else */\r\n\t\t\tif (wholeSchema.hasOwnProperty(key)) {\r\n\t\t\t\tlet rule = wholeSchema[key] as joi.Schema;\r\n\t\t\t\t/* istanbul ignore else */\r\n\t\t\t\tif (typeof rule.optional === 'function') {\r\n\t\t\t\t\tpartialSchema[key] = rule.optional();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._compiledPartial = joi.object(partialSchema);\r\n\r\n\t\t// Compile rule for id\r\n\t\tlet idMap = this._schemaMapId;\r\n\t\tfor (let key in idMap) {\r\n\t\t\t/* istanbul ignore else */\r\n\t\t\tif (idMap.hasOwnProperty(key)) {\r\n\t\t\t\t// key can be `id`, `ID`, `Id`... whatever\r\n\t\t\t\tthis._compiledId = idMap[key] as joi.ObjectSchema;\r\n\t\t\t\tbreak; // Only get the first rule\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprotected validate(schema: joi.ObjectSchema, target: any, options: ValidationOptions = {}): [ValidationError, T] {\r\n\t\tGuard.assertIsDefined(schema, 'Must call `compile` before using this function!');\r\n\r\n\t\tlet opts = Object.assign({\r\n\t\t\t\tabortEarly: false,\r\n\t\t\t\tallowUnknown: true,\r\n\t\t\t\tstripUnknown: true,\r\n\t\t\t\tisEdit: false\r\n\t\t\t}, options);\r\n\r\n\t\t// If edit mode, validate id property.\r\n\t\tschema = opts.isEdit ? schema.keys(this._schemaMapId) : schema;\r\n\t\tdelete opts.isEdit;\r\n\t\tlet { error, value } = schema.validate<T>(target, opts);\r\n\r\n\t\treturn (error) ? [new ValidationError(error.details), null] : [null, value];\r\n\t}\r\n}"]}